{% extends 'base.html' %}

{% block title %}
KBMS | Account
{% endblock %}

{% block content %}
<h2>储蓄账户</h2>
<table id="savingAccountTable" class="table table-striped table-bordered table-sm">
  <thead>
  <tr>
    <th>所属用户</th>
    <th>余额</th>
    <th>利率</th>
    <th>开户日期</th>
    <th>负责人</th>
    <th>开户支行</th>
    <th>操作</th>
  </tr>
  </thead>
  <tbody>
  {% for account in saving_account_list %}
  <tr>
    <td><a href="{% url 'customer:update' account.customer.pk %}">{{ account.customer.name }}</a></td>
    <td>{{ account.balance }}</td>
    <td>{{ account.interest_rate }}</td>
    <td>{{ account.date_opened }}</td>
    <td>{{ account.manager.name }}</td>
    <td>{{ account.branch.name }}</td>
    <td><a href="{% url 'account:saving_update' account.pk %}"><i class="fas fa-info-circle"></i></a> |
        <a class="open-modal" data-target="#deleteModal" data-toggle="modal"
           data-url="{% url 'account:saving_delete' account.pk %}"
           data-customer_name="{{ account.customer.name }}"><i class="fas fa-trash"></i></a></td>
  </tr>
  {% endfor %}
  </tbody>
</table>

<h2>支票账户</h2>
<table id="checkingAccountTable" class="table table-striped table-bordered table-sm">
  <thead>
  <tr>
    <th>所属用户</th>
    <th>余额</th>
    <th>透支额</th>
    <th>开户日期</th>
    <th>负责人</th>
    <th>开户支行</th>
    <th>操作</th>
  </tr>
  </thead>
  <tbody>
  {% for account in checking_account_list %}
  <tr>
    <td><a href="{% url 'customer:update' account.customer.pk %}">{{ account.customer.name }}</a></td>
    <td>{{ account.balance }}</td>
    <td>{{ account.overdraft }}</td>
    <td>{{ account.date_opened }}</td>
    <td>{{ account.manager.name }}</td>
    <td>{{ account.branch.name }}</td>
    <td><a href="{% url 'account:checking_update' account.pk %}"><i class="fas fa-info-circle"></i></a> |
        <a class="open-modal" data-target="#deleteModal" data-toggle="modal"
           data-url="{% url 'account:checking_delete' account.pk %}"
           data-customer_name="{{ account.customer.name }}"><i class="fas fa-trash"></i></a></td>
  </tr>
  {% endfor %}
  </tbody>
</table>

<div class="modal fade" tabindex="-1" role="dialog" id="deleteModal">
  <div class="modal-dialog modal-notify modal-danger" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title white-text">警告：删除账户</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true" class="white-text">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>你确定要删除"<span id="modalCustomerName"></span>"的该账户吗？</p>
        <form id="deleteForm" method="post">{% csrf_token %}</form>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-danger" form="deleteForm">确定</button>
        <button type="button" class="btn btn-outline-danger" data-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
  $(document).ready(function () {
    $('#savingAccountTable').DataTable({
      "aaSorting": [],
      columnDefs: [{
        orderable: false,
        targets: 6
      }]
    });
    $('#checkingAccountTable').DataTable({
      "aaSorting": [],
      columnDefs: [{
        orderable: false,
        targets: 6
      }]
    });
    $('.dataTables_length').addClass('bs-select');
  });

  $(document).on("click", ".open-modal", function () {
    let customerName = $(this).data('customer_name');
    let url = $(this).data('url');
    $('#modalCustomerName').text(customerName);
    $('#deleteForm').attr('action', url);
    // As pointed out in comments,
    // it is unnecessary to have to manually call the modal.
    // $('#addBookDialog').modal('show');
  });
</script>
{% endblock %}
